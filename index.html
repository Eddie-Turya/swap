<!DOCTYPE html>
<html>
<head>
    <title>Swap USDT ↔ SOL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
        input, button, select { padding: 12px; width: 100%; margin-top: 10px; font-size: 16px; }
        .result { margin-top: 15px; }
    </style>
</head>
<body>

<h2>USDT ↔ SOL Swap</h2>
<button id="connectBtn">Connect Phantom Wallet</button>
<p id="walletStatus"></p>

<select id="directionSelect">
    <option value="usdt-to-sol">USDT → SOL</option>
    <option value="sol-to-usdt">SOL → USDT</option>
</select>

<input type="number" id="amountInput" placeholder="Enter amount" />
<button id="swapBtn">Swap Now</button>

<div class="result" id="quoteResult"></div>

<script type="module">
import {
    Connection,
    PublicKey,
    VersionedTransaction
} from "https://cdn.skypack.dev/@solana/web3.js";

const USDT_MINT = "Es9vMFrzaCERiTxz5G2ZyyuRNPQ5TC3gXkJqB6HZ4iGz";
const SOL_MINT = "So11111111111111111111111111111111111111112";
const YOUR_FEE_WALLET = "HtA663NyM3EGzQMx9pCQFS7n79ktKDvSVJZmiogjwqLJ";

let userPublicKey = null;

const connection = new Connection("https://api.mainnet-beta.solana.com");

document.getElementById("connectBtn").onclick = async () => {
    if (window.solana && window.solana.isPhantom) {
        try {
            const resp = await window.solana.connect();
            userPublicKey = resp.publicKey.toString();
            document.getElementById("walletStatus").textContent = "Connected: " + userPublicKey;
        } catch (err) {
            alert("Connection failed.");
        }
    } else {
        alert("Please install Phantom Wallet.");
    }
};

document.getElementById("swapBtn").onclick = async () => {
    const amount = parseFloat(document.getElementById("amountInput").value);
    const direction = document.getElementById("directionSelect").value;
    if (!userPublicKey) return alert("Connect your wallet first.");
    if (!amount || amount <= 0) return alert("Enter a valid amount.");

    const inputMint = direction === "usdt-to-sol" ? USDT_MINT : SOL_MINT;
    const outputMint = direction === "usdt-to-sol" ? SOL_MINT : USDT_MINT;
    const inputDecimals = direction === "usdt-to-sol" ? 6 : 9;

    const fee = amount * 0.0003;
    const amountAfterFee = amount - fee;
    const amountIn = Math.floor(amountAfterFee * Math.pow(10, inputDecimals));

    const quoteUrl = `https://quote-api.jup.ag/v6/swap?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amountIn}&slippageBps=50&feeBps=3&feeAccount=${YOUR_FEE_WALLET}&userPublicKey=${userPublicKey}`;
    
    try {
        const response = await fetch(quoteUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
        });

        const data = await response.json();
        const swapTx = data.swapTransaction;

        if (!swapTx) {
            return alert("Swap not available right now.");
        }

        const transaction = VersionedTransaction.deserialize(Buffer.from(swapTx, "base64"));
        const signedTx = await window.solana.signTransaction(transaction);
        const txid = await connection.sendRawTransaction(signedTx.serialize());

        document.getElementById("quoteResult").innerHTML = `
            ✅ Transaction Sent: <a href="https://solscan.io/tx/${txid}" target="_blank">${txid}</a><br>
            Fee sent: ${fee.toFixed(inputDecimals)} to your wallet
        `;
    } catch (err) {
        console.error(err);
        alert("Swap failed.");
    }
};
</script>

</body>
</html>
